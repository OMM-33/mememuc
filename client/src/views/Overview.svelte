<script>
	import { memes, updateMemes } from "../cache";

	import Button from "../lib/Button.svelte";
	import Graph from "../lib/Graph.svelte";
	import Frame from "../lib/View/Frame.svelte";
	import Select from 'svelte-select';
	import InfiniteScroll from "svelte-infinite-scroll";

	updateMemes();
	const items = [
		{ value:1, label: '10 views'},
		{ value:2, label: '20 views'},
		{ value:3, label: '10 upvotes'},
		{ value:4, label: '20 upvotes'},
	];
	let selected;
	let memesArray = [];
	$: {
		const result = [];
		const memeStores = [...$memes.values()];
		memeStores.forEach((store, i) => store.subscribe(value => result[i] = value));
		memesArray = result;
	}

	$: publicMemes = memesArray.filter(({ privacy }) => privacy === "public");

	$: stats = Object.fromEntries(
		Object.entries(
			publicMemes.reduce((result, meme) => {
				const date = meme.updateDate;
				const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
				if (!result[dateStr]) result[dateStr] = 0;
				result[dateStr]++;
				return result;
			}, {}),
		)
			.sort(([dateA], [dateB]) => dateA < dateB ? -1 : 1)
			.map(([date, count]) => {
				const [year, month] = date.split("-");
				return [`${month}/${year}`, count];
			}),
	);

	let statsVisible = false;

	function sortBy(criterium){
		console.log("Sort by: " + criterium);
	}
	function filter(){
		try{
			console.log("Filter: " + selected.value);
		}catch{
			console.log("No filter");
		}

	}
	let newBatch = [];

	function fetchData() {
		newBatch++;
		console.log(newBatch);
	}
</script>

<h1>Overview </h1>

<div class="top-controls">
	<div class="sort"><p style="margin-right: 1em">Sort by:</p><Button on:click={()=>sortBy("date")}>Date</Button><Button on:click={()=>sortBy("title")}>Title</Button></div>
	<div class="filter"> <p>more than</p> <Select id="filter" {items} bind:value={selected}/> <Button on:click={filter}>Filter</Button>	</div>
	<Button style="margin-left: auto" on:click={() => statsVisible = !statsVisible}>
		ðŸ“‰ {statsVisible ? "Hide" : "Show"} Statistics
	</Button>
</div>
{#if statsVisible}
	<div class="graph">
		<Graph
			type="line"
			labels={Object.keys(stats)}
			datasets={[{
				label: "Memes created",
				data: Object.values(stats),
				backgroundColor: "#26ba8955",
				borderColor: "#26ba89",
			}]}
			options={{
				scale: {
					ticks: {
						precision: 0,
					},
				},
			}}
		/>
	</div>
{/if}
<div class="grid">
	{#each publicMemes as meme}
		<Frame {meme} />
	{/each}
</div>
<InfiniteScroll
	hasMore={newBatch.length}
	threshold={10}
	on:loadMore={() => {fetchData;}} />

<style>
	.top-controls {
		display: flex;
		font-size: 0.75em;
		margin-bottom: 1em;

	}

	.graph {
		margin-bottom: 4em;
	}

	.grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
		justify-content: space-between;
		row-gap: 4em;
		column-gap: 1em;
	}
	.sort{
		display: flex;
		justify-content: space-between;

	}
	.filter{
		margin-left: 20%;
		display: flex;
		width: 20vw;

	}
</style>
