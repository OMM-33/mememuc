<script>
	import { onDestroy, onMount } from "svelte";
	import prettyBytes from "pretty-bytes";

	import { compressImage, getUID } from "../../util";
	import Media from "../../models/Media";
	import Button from "../Button.svelte";
	import Card from "../Card.svelte";

	export let meme;
	export let compressedMedia = null;
	export let close;

	const uid = getUID();
	const target = { kb: 0, types: ["image/jpeg", "image/webp"], type: "image/jpeg" };

	$: media = compressedMedia || $meme;

	const compress = async () => {
		const bytes = target.kb * 1000;

		const blob = await compressImage($meme.src, bytes, target.type);
		if (compressedMedia) return; // User could click fast... :)
		compressedMedia?.destroy();
		compressedMedia = new Media({ blob });
	};

	const restoreUncompressed = () => {
		compressedMedia = null;
		compressedMedia?.destroy();
	};

	const mimeToFileType = mime => mime.split("/").at(-1).toUpperCase();

	onMount(() => {
		target.kb = Math.floor(media?.blob.size / 1000 / 8);
	});

	onDestroy(() => {
		compressedMedia?.destroy();
	});
</script>

<Card {close}>
	<h3 slot="header" style:margin="0">Generated Meme</h3>
	<div class="content">
		<img src={media.src} />
		<div class="controls">
			<div class="row">
				<Button variant="primary" style="flex-grow: 1">✔️ Save in Profile</Button>
				<Button>📲 Share</Button>
			</div>
			<div class="row">
				<div>
					<Button element="a" href={media.src} download="meme">📥 Download</Button>
				</div>
				<div>
					{#if !compressedMedia}
						<Button on:click={compress}>🗜️ Compress</Button>
					{:else}
						<Button on:click={restoreUncompressed}>🗜️ Restore uncompressed</Button>
					{/if}
					<input
						type="number"
						id="compress-kb-{uid}"
						size="6"
						min="0"
						max="10000"
						bind:value={target.kb}
					/>
					<label for="compress-kb-{uid}">kB</label>
					as
					<select bind:value={target.type}>
						{#each target.types as type}
							<option value={type}>{mimeToFileType(type)}</option>
						{/each}
					</select>
				</div>
			</div>
		</div>
	</div>
	<div class="metadata" slot="footer">
		<div class="filetype">
			🖼️ {mimeToFileType(media.blob.type)}
		</div>
		<div class="size">
			💾 {prettyBytes(media.blob.size)}
		</div>
	</div>
</Card>

<style>
	.content {
		display: flex;
		flex-direction: column;
		gap: 1em;

		width: 800px;
		height: 800px;
		max-width: 100%;
		max-height: 100%;
	}

	.controls {
		flex-shrink: 0;

		display: flex;
		flex-direction: column;
		gap: 0.5em;
	}

	.row {
		display: flex;
		align-items: center;
		gap: 0.5em;
	}

	.metadata {
		width: 100%;
		display: flex;
		justify-content: flex-end;
		gap: 1.5em;
	}

	img {
		flex-grow: 1;
		height: 0;
		object-fit: contain;
	}
</style>
